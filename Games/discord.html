<!DOCTYPE html>
<html lang="en">
<head>
<!-- This was inpired by Discord, and was created by EyesHD 
Discord: erroryt_eren
Roblox: Eren_Hacketo
Tiktok: @eyeshd-offical

Made by EyesHD | V1.6 BETA
[NOTE] IF YOU COPY W3Chat, YOU WILL BE SUED OR YOUR SITE WILL BE TAKEN DOWN. 
You can make an link of W3chat, Just incase if this link is blocked for you. 

JOIN THE DISCORD SERVER FOR MORE LINKS!! -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Classes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-rail:#202225; --bg-side:#2f3136; --bg-main:#36393f; --text:#dcddde; --brand:#5865F2; --call-bg: #000000; }
        body { background:var(--bg-main); color:var(--text); font-family:'gg sans',sans-serif; overflow:hidden; }
        ::-webkit-scrollbar { width:8px; height:8px; background:#2b2d31; }
        ::-webkit-scrollbar-thumb { background:#1a1b1e; border-radius:4px; }
        
        .s-icon { transition:0.2s; background-size:cover; background-position:center; cursor:pointer; width:48px; height:48px; border-radius:50%; background:#36393f; color:#dcddde; display:flex; align-items:center; justify-content:center; margin-bottom:8px; position:relative; }
        .s-icon:hover, .s-icon.active { border-radius:30%; background:var(--brand); color:white; }
        
        .unread-pill { position: absolute; left: -14px; top: 50%; transform: translateY(-50%); width: 8px; height: 8px; background: white; border-radius: 0 4px 4px 0; display: none; transition: 0.2s; }
        .s-icon:hover .unread-pill { height: 20px; display: block; }
        .s-icon.unread .unread-pill { display: block; height: 8px; }
        .s-icon.active .unread-pill { display: block; height: 40px; }

        .ch-item:hover { background:#35373c; color:#fff; } .ch-item.active { background:#393c43; color:#fff; }
        .msg:hover { background:#32353b; } .msg:hover .acts { display:flex; } 
        .markdown a { color:#00aff4; text-decoration:underline; } .markdown img { max-width:300px; border-radius:5px; cursor:pointer; }
        .mention { background-color: rgba(88, 101, 242, 0.3); color: #dee0fc; padding: 0 2px; border-radius: 3px; cursor: pointer; font-weight: 500; }
        .mention-everyone { background-color: rgba(250, 166, 26, 0.1); color: #faa61a; padding: 0 2px; border-radius: 3px; font-weight: bold; }
        .mention-everyone:hover { background-color: rgba(250, 166, 26, 0.3); }
        .role-mention { padding: 0 2px; border-radius: 3px; font-weight: 500; background: rgba(255,255,255,0.05); cursor: pointer; }
        .role-mention:hover { background: rgba(255,255,255,0.1); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid #2f3136; position: absolute; bottom: 0; right: 0; }
        .status-online { background-color: #3ba55c; } .status-idle { background-color: #faa61a; } .status-dnd { background-color: #ed4245; } .status-offline { background-color: #747f8d; }
        .notification-badge { position: absolute; bottom: -2px; right: -2px; background-color: #ed4245; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 2px solid #202225; font-weight: bold; }
        .landing-bg { background-image: url('https://cdn.pixabay.com/photo/2016/06/02/02/33/triangles-1430105_1280.png'); background-size: cover; background-position: center; }
        .drag-over { background-color: rgba(88, 101, 242, 0.2); }
        .recording { color: #ed4245; animation: pulse 1.5s infinite; }
        .nitro-gradient { background: linear-gradient(45deg, #ff00cc, #3333ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; }
        .nitro-card { background: linear-gradient(135deg, #2b2d31 0%, #1e1f22 100%); border: 1px solid #ff73fa; }
        .bot-tag { background: #5865F2; color: white; font-size: 10px; padding: 1px 4px; border-radius: 4px; margin-left: 4px; display: inline-flex; align-items: center; height: 15px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .typing-dots::after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }
        .call-tile { background-color: #000; border-radius: 8px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; aspect-ratio: 16/9; min-height: 200px; }
        .call-controls { background-color: #2f3136; border-radius: 16px; padding: 8px 16px; display: flex; gap: 16px; }
        .control-btn { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; cursor: pointer; background: #36393f; color: white; }
        .control-btn:hover { background: #40444b; }
        .control-btn.red { background: #ed4245; } .control-btn.red:hover { background: #c03537; }
        .control-btn.active { background: #fff; color: #36393f; }
        #updates-sidebar { transition: transform 0.3s ease-in-out; }
        .admin-tab.active { border-bottom: 2px solid #5865F2; color: white; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #2f3136; border-left: 4px solid #5865F2; padding: 12px 20px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); transform: translateX(100%); transition: transform 0.3s ease-out; color: white; min-width: 250px; pointer-events: auto; }
        .toast.show { transform: translateX(0); }
        .toast.error { border-left-color: #ed4245; }
        .toast.broadcast { border-left-color: #9b59b6; background: #202225; }
        .toast.success { border-left-color: #3ba55c; }
        .reaction-pill { background: #2f3136; border-radius: 4px; padding: 2px 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; border: 1px solid transparent; }
        .reaction-pill:hover { border-color: #5865F2; }
        .reaction-pill.active { background: rgba(88, 101, 242, 0.15); border-color: #5865F2; }
        .mobile-hide { display: none; } @media(min-width:768px){ .mobile-hide{ display:flex; } }
        .nitro-table th, .nitro-table td { padding: 10px; text-align: left; border-bottom: 1px solid #3f4147; }
        .nitro-table th { color: #b9bbbe; font-size: 12px; text-transform: uppercase; }
        .nitro-table td { color: white; font-size: 14px; }
        .check-icon { color: #3ba55c; }
        .cross-icon { color: #ed4245; }
        #dm-alert-modal { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="flex h-screen w-screen select-none text-sm" onclick="window.enableAudio()">

    <div id="toast-container"></div>
    <audio id="remote-audio" autoplay></audio>

    <div id="dm-alert-modal" class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-black bg-opacity-80">
        <div class="bg-[#36393f] rounded p-6 shadow-2xl border border-[#202225] w-96 text-center">
            <div class="mb-4"><i class="fas fa-envelope text-4xl text-[#5865F2]"></i></div>
            <h3 class="text-white font-bold text-lg mb-2">New Message</h3>
            <p id="dm-alert-text" class="text-gray-300 mb-6"></p>
            <button onclick="window.closeDmAlert()" class="bg-[#5865F2] text-white px-6 py-2 rounded hover:bg-blue-600 transition">OK</button>
        </div>
    </div>

    <div id="landing-page" class="fixed inset-0 z-[60] bg-[#404eed] overflow-y-auto">
        <div class="landing-bg min-h-screen flex flex-col">
            <nav class="flex justify-between items-center p-6 max-w-6xl mx-auto w-full"><div class="flex items-center text-white font-bold text-xl"><i class="fab fa-discord mr-2"></i> W3Chat</div><button onclick="window.showLogin()" class="bg-white text-black px-4 py-2 rounded-full text-sm hover:shadow-lg transition">Login</button></nav>
            <div class="flex-1 flex flex-col items-center justify-center text-center px-4">
                <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-6 uppercase">Imagine a Place...</h1>
                <p class="text-white text-lg max-w-2xl mb-8 opacity-90">Where you and your friends can spend time together.</p>
                <div class="w-full max-w-4xl bg-black rounded-xl overflow-hidden shadow-2xl mb-8 border-4 border-[#2f3136] relative">
                    <div class="absolute top-4 left-4 bg-red-600 text-white px-3 py-1 rounded font-bold uppercase text-xs z-10">New: Mobile Support</div>
                    <video autoplay loop muted playsinline class="w-full h-auto opacity-80">
                        <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                <button onclick="window.showLogin()" class="bg-[#2f3136] text-white px-8 py-3 rounded-full hover:shadow-xl transition font-bold text-lg">Open W3Chat</button>
            </div>
        </div>
    </div>

    <div id="call-overlay" class="hidden fixed inset-0 z-[100] bg-black flex flex-col">
        <div class="absolute top-4 left-4 z-50"><button onclick="window.endVoiceCall()" class="bg-red-500 text-white px-4 py-2 rounded font-bold shadow-lg hover:bg-red-600 transition"><i class="fas fa-phone-slash mr-2"></i> End Call</button></div>
        <div id="jitsi-container" class="w-full h-full bg-black"></div>
    </div>

    <div id="auth-screen" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-[#5865F2] bg-opacity-10 backdrop-blur-sm bg-[url('https://cdn.pixabay.com/photo/2016/06/02/02/33/triangles-1430105_1280.png')] bg-cover bg-center">
        <div class="bg-[#36393f] p-8 rounded shadow-2xl w-full max-w-sm relative"><button onclick="window.hideLogin()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button><h2 class="text-2xl font-bold text-white text-center mb-6">Welcome Back!</h2><form id="login-form" class="space-y-4" onsubmit="return window.handleLogin(event)"><div><label class="block text-xs font-bold text-[#b9bbbe] uppercase mb-1">Email</label><input type="email" id="email" class="w-full bg-[#202225] p-2 rounded text-white" required></div><div><label class="block text-xs font-bold text-[#b9bbbe] uppercase mb-1">Password</label><input type="password" id="password" class="w-full bg-[#202225] p-2 rounded text-white" required><div class="text-xs text-blue-400 cursor-pointer hover:underline" onclick="window.handleForgotPassword()">Forgot Password?</div></div><button type="submit" class="w-full bg-[#5865F2] py-2 rounded text-white">Login</button><div id="login-msg" class="text-center text-xs text-[#b9bbbe] h-4 mt-2"></div></form></div>
    </div>

    <div id="app-screen" class="hidden flex w-full h-full relative overflow-hidden">
        <div id="server-rail" class="w-[72px] bg-[#202225] flex flex-col items-center py-3 overflow-y-auto no-scrollbar z-20 shadow-lg">
            <div onclick="window.renderHome()" class="s-icon active mb-2"><i class="fa-brands fa-discord text-xl"></i><div id="home-badge" class="notification-badge hidden">!</div></div>
            <div class="w-8 h-[2px] bg-[#36393f] rounded mb-2"></div><div id="server-list" class="w-full flex flex-col items-center"></div>
            <div onclick="window.openModal('create-server-modal')" class="s-icon text-green-500 hover:text-white hover:bg-green-500"><i class="fas fa-plus"></i></div>
            <div onclick="window.renderDiscovery()" class="s-icon text-[#b9bbbe] hover:text-white hover:bg-green-600 mt-2"><i class="fas fa-compass"></i></div>
        </div>

        <div id="sidebar-panel" class="w-60 bg-[#2f3136] flex flex-col border-r border-[#202225] flex-shrink-0 transition-all duration-300 absolute md:relative z-10 h-full md:translate-x-0">
            <div id="sidebar-header-container" class="h-12 px-4 flex items-center justify-between shadow-sm hover:bg-[#34373c] cursor-pointer transition-colors group">
                <div class="flex items-center min-w-0"><h1 id="sidebar-header" class="font-bold text-white truncate text-base">Home</h1></div>
                <div class="flex items-center">
                    <i id="admin-panel-btn" class="fas fa-shield-alt text-xs text-red-400 hover:text-red-300 mr-2 hidden" onclick="window.openModal('admin-panel-modal');window.loadAdminView('users')" title="Admin"></i>
                    <i id="server-settings-icon" class="fas fa-cog text-xs text-[#b9bbbe] hover:text-white mr-2 hidden" onclick="window.openServerSettings()"></i>
                    <i id="invite-icon" class="fas fa-user-plus text-xs text-[#b9bbbe] hover:text-white hidden" onclick="window.openModal('invite-modal');window.loadInviteFriends()"></i>
                </div>
            </div>
            <div id="channels-list" class="flex-1 overflow-y-auto p-2 space-y-0.5 custom-scrollbar"></div>
            <div class="h-[52px] bg-[#292b2f] flex items-center px-2 cursor-pointer hover:bg-[#34373c] transition-colors" onclick="window.openModal('user-settings-modal')">
                <div class="relative w-8 h-8 mr-2"><div id="current-user-avatar" class="w-8 h-8 rounded-full bg-gray-500 flex items-center justify-center text-white text-xs font-bold overflow-hidden"><img id="current-user-img" class="hidden w-full h-full object-cover"><i id="current-user-icon" class="fas fa-user"></i></div><div id="connection-status" class="status-dot status-idle"></div></div>
                <div class="flex-1 overflow-hidden"><div id="current-username" class="text-sm font-bold text-white truncate">User</div><div id="current-discriminator" class="text-xs text-[#b9bbbe]">#0000</div></div>
            </div>
        </div>

        <div id="main-panel" class="flex-1 flex flex-col bg-[#36393f] min-w-0 relative w-full absolute md:relative transform translate-x-full md:translate-x-0 transition-transform duration-300 h-full z-20">
            <div class="h-12 px-4 flex items-center shadow-md border-b border-[#26272d] flex-shrink-0 justify-between bg-[#36393f]">
                <div class="flex items-center overflow-hidden"><i class="fas fa-arrow-left text-[#dcddde] mr-4 md:hidden cursor-pointer text-lg" onclick="window.showMobileSidebar()"></i><i id="channel-icon" class="fas fa-hashtag text-[#72767d] mr-2 text-xl"></i><h3 id="chat-header" class="font-bold text-white mr-4 truncate">Select</h3>
                <span id="channel-topic" class="text-xs text-[#72767d] hidden md:block truncate max-w-xs border-l border-[#3f4147] pl-4 ml-2"></span>
                <i id="channel-settings-btn" class="fas fa-cog text-xs text-[#b9bbbe] hover:text-white ml-2 hidden cursor-pointer" onclick="window.openChannelSettings()"></i></div>
                
                <div class="flex items-center space-x-4">
                     <i id="update-bell" class="fas fa-bell text-[#b9bbbe] text-xl cursor-pointer hover:text-white relative" onclick="window.toggleUpdates()"><div id="update-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center hidden font-bold">0</div></i>
                     <div id="dm-actions" class="hidden flex space-x-4 text-[#b9bbbe] text-xl"><i class="fas fa-phone-alt hover:text-white cursor-pointer text-base" onclick="window.startVoiceCall()"></i></div>
                     <i class="fas fa-user-friends text-[#b9bbbe] text-xl md:hidden cursor-pointer" onclick="window.toggleMemberList()"></i>
                </div>
            </div>
            
            <div id="active-call-banner" class="hidden bg-green-600 p-2 flex items-center justify-center space-x-4 cursor-pointer hover:bg-green-700" onclick="window.expandCall()"><div class="text-white text-sm font-bold flex items-center"><i class="fas fa-phone-volume animate-ring mr-2 text-white"></i><span id="banner-status-text">Click to return to call</span></div></div>
            <div id="incoming-call-banner" class="hidden bg-black bg-opacity-80 p-4 absolute top-14 left-4 right-4 z-50 rounded flex items-center justify-between shadow-xl border border-gray-700"><div class="flex items-center"><div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center mr-3"><i class="fas fa-user text-white"></i></div><div class="text-white font-bold">Incoming Call...</div></div><div class="flex space-x-2"><button onclick="window.answerVoiceCall()" class="bg-green-500 text-white px-4 py-2 rounded-full">Answer</button><button onclick="window.declineVoiceCall()" class="bg-red-500 text-white px-4 py-2 rounded-full">Decline</button></div></div>
            <div id="discovery-view" class="hidden absolute inset-0 bg-[#36393f] flex flex-col"><div class="p-6"><h1 class="text-2xl font-bold text-white mb-4">Discovery</h1><div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="discovery-list"></div></div></div>

            <div id="content-area" class="flex-1 overflow-hidden relative flex flex-col">
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-1 custom-scrollbar flex flex-col"></div>
                <div id="friends-view" class="hidden absolute inset-0 bg-[#36393f] flex flex-col"><div class="p-4 border-b border-[#26272d] flex items-center justify-between"><h2 class="text-white font-bold">Friends</h2><div class="flex space-x-2"><button onclick="window.openModal('create-group-dm-modal')" class="bg-[#2f3136] text-white px-3 py-1 rounded text-xs">New Group</button><button onclick="window.openModal('add-friend-modal')" class="bg-green-600 text-white px-3 py-1 rounded text-xs">Add Friend</button></div></div><div id="friends-list" class="flex-1 overflow-y-auto p-4 space-y-2"></div></div>
            </div>
            <div id="typing-indicator" class="px-4 py-1 h-6 text-xs text-[#dcddde] font-bold typing-dots hidden"></div>
            <div id="input-area" class="px-4 pb-6 pt-0">
                <div id="reply-bar" class="hidden bg-[#2f3136] px-4 py-1 rounded-t-lg flex justify-between items-center text-xs text-[#b9bbbe] border-b border-[#202225]"><span>Replying to <span id="reply-username" class="font-bold text-white">User</span></span><i class="fas fa-times cursor-pointer hover:text-white" onclick="window.cancelReply()"></i></div>
                <div class="bg-[#40444b] rounded-lg px-4 py-2.5 flex items-center relative">
                    <button class="text-[#b9bbbe] hover:text-[#dcddde] mr-2 sticky bg-[#40444b] rounded-full p-1" onclick="document.getElementById('chat-file-input').click()"><i class="fas fa-plus-circle text-xl"></i></button>
                    <button id="record-btn" class="text-[#b9bbbe] hover:text-[#dcddde] mr-3 sticky bg-[#40444b] rounded-full p-1" onclick="window.toggleRecording()"><i class="fas fa-microphone text-xl"></i></button>
                    
                    <input type="file" id="chat-file-input" hidden>
                    <textarea id="message-input" class="bg-transparent flex-1 outline-none text-[#dcddde] placeholder-[#72767d] resize-none h-10 py-2 custom-scrollbar" placeholder="Message" oninput="window.handleTyping()"></textarea>
                    
                    <div class="relative">
                        <button class="text-[#b9bbbe] hover:text-[#dcddde] mr-2 sticky bg-[#40444b] rounded-full p-1" onclick="document.getElementById('emoji-picker').classList.toggle('hidden')"><i class="fas fa-smile text-xl"></i></button>
                        <div id="emoji-picker" class="hidden absolute bottom-10 right-0 bg-[#2f3136] p-2 rounded shadow-lg grid grid-cols-4 gap-2 w-48 z-50">
                            <span class="cursor-pointer text-xl hover:bg-gray-700 rounded p-1" onclick="window.addEmoji('üëç')">üëç</span>
                            <span class="cursor-pointer text-xl hover:bg-gray-700 rounded p-1" onclick="window.addEmoji('üòÇ')">üòÇ</span>
                            <span class="cursor-pointer text-xl hover:bg-gray-700 rounded p-1" onclick="window.addEmoji('üòÆ')">üòÆ</span>
                            <span class="cursor-pointer text-xl hover:bg-gray-700 rounded p-1" onclick="window.addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                            <span class="cursor-pointer text-xl hover:bg-gray-700 rounded p-1" onclick="window.addEmoji('üò°')">üò°</span>
                            <span class="cursor-pointer text-xl hover:bg-gray-700 rounded p-1" onclick="window.addEmoji('üéâ')">üéâ</span>
                            <span class="cursor-pointer text-xl hover:bg-gray-700 rounded p-1" onclick="window.addEmoji('üò≠')">üò≠</span>
                            <span class="cursor-pointer text-xl hover:bg-gray-700 rounded p-1" onclick="window.addEmoji('üëÄ')">üëÄ</span>
                        </div>
                    </div>
                </div>
                <div id="read-only-msg" class="hidden text-xs text-red-400 mt-2 text-center">You do not have permission to send messages in this channel.</div>
            </div>
        </div>

        <div id="member-list" class="w-60 bg-[#2f3136] hidden md:flex flex-col p-3 overflow-y-auto border-l border-[#202225] custom-scrollbar absolute right-0 h-full z-30 md:static"></div>
        <div id="updates-sidebar" class="fixed top-0 right-0 h-full w-80 bg-[#2f3136] shadow-2xl z-40 transform translate-x-full border-l border-[#202225] flex flex-col transition-transform duration-300">
            <div class="p-4 border-b border-[#202225] flex justify-between items-center"><h2 class="text-white font-bold text-lg">Updates</h2><i class="fas fa-times text-gray-400 cursor-pointer" onclick="window.toggleUpdates()"></i></div>
            <div id="updates-list" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
        </div>
    </div>

    <div id="create-server-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70"><div class="bg-[#36393f] rounded w-96 p-6 relative"><button onclick="window.closeModal('create-server-modal')" class="absolute top-2 right-2 text-white">x</button><h2 class="text-white font-bold mb-4">Create Server</h2><input id="new-server-name" class="w-full bg-[#202225] p-2 text-white rounded mb-2" placeholder="Name"><input id="new-server-icon" class="w-full bg-[#202225] p-2 text-white rounded mb-2" placeholder="Icon URL"><input type="file" id="new-server-file" class="text-xs text-gray-400 mb-4"><div class="flex justify-between"><button onclick="window.closeModal('create-server-modal');window.openModal('join-server-modal')" class="text-blue-400 text-xs">Join</button><button onclick="window.handleCreateServer()" class="bg-[#5865F2] text-white px-4 py-1 rounded">Create</button></div></div></div>
    <div id="join-server-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70"><div class="bg-[#36393f] rounded w-96 p-6 relative"><button onclick="window.closeModal('join-server-modal')" class="absolute top-2 right-2 text-white">x</button><h2 class="text-white font-bold mb-4">Join Server</h2><input id="join-invite-code" class="w-full bg-[#202225] p-2 text-white rounded mb-4" placeholder="Code"><button onclick="window.handleJoinServer()" class="bg-green-600 w-full py-1 rounded text-white">Join</button></div></div>
    <div id="create-category-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70"><div class="bg-[#36393f] rounded w-96 p-6"><h2 class="text-lg font-bold text-white mb-4">Create Category</h2><input id="new-category-name" class="w-full bg-[#202225] p-2 text-white rounded mb-4" placeholder="CATEGORY NAME"><div class="flex justify-end"><button onclick="window.closeModal('create-category-modal')" class="text-white mr-2">Cancel</button><button onclick="window.handleCreateCategory()" class="bg-[#5865F2] text-white px-4 py-1 rounded">Create</button></div></div></div>
    <div id="add-friend-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70"><div class="bg-[#36393f] rounded w-96 p-6"><h2 class="text-lg font-bold text-white mb-2">Add Friend</h2><input id="friend-username-input" class="w-full bg-[#202225] p-2 text-white rounded mb-4" placeholder="Username"><div class="flex justify-end"><button onclick="window.closeModal('add-friend-modal')" class="text-white mr-2">Cancel</button><button onclick="window.sendFriendRequest()" class="bg-[#3ba55c] text-white px-4 py-1 rounded">Send</button></div></div></div>
    <div id="create-group-dm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70"><div class="bg-[#36393f] rounded w-96 p-6 relative"><button onclick="window.closeModal('create-group-dm-modal')" class="absolute top-2 right-2 text-white">x</button><h2 class="text-lg font-bold text-white mb-2">Create Group DM</h2><div id="group-friend-list" class="max-h-40 overflow-y-auto mb-4"></div><button id="create-group-btn" class="bg-[#5865F2] w-full py-1 rounded text-white">Create</button></div></div>
    <div id="invite-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70"><div class="bg-[#36393f] rounded w-96 p-6 text-center"><input id="invite-code-display" class="bg-[#202225] w-full p-2 text-white rounded mb-2" readonly><button onclick="window.copyInviteCode()" id="copy-btn" class="bg-[#5865F2] w-full py-1 rounded text-white">Copy</button><div id="invite-friends-list" class="mt-4 text-left max-h-40 overflow-y-auto"></div><button onclick="window.closeModal('invite-modal')" class="text-gray-400 mt-2">Close</button></div></div>
    <div id="create-channel-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70"><div class="bg-[#36393f] rounded w-96 p-6"><h2 class="text-lg font-bold text-white mb-4">Create Channel</h2><input id="new-channel-name" class="w-full bg-[#202225] p-2 text-white rounded mb-4" placeholder="Name"><div class="mb-4"><label class="text-xs font-bold text-[#b9bbbe]">Category</label><select id="new-channel-category" class="w-full bg-[#202225] text-white p-2 rounded"></select></div><label class="flex items-center text-white mb-4"><input type="checkbox" id="new-channel-readonly" class="mr-2"> Read-Only</label><div class="flex justify-end"><button onclick="window.closeModal('create-channel-modal')" class="text-white mr-2">Cancel</button><button onclick="window.handleCreateChannel()" class="bg-[#5865F2] text-white px-4 py-1 rounded">Create</button></div></div></div>
    
    <div id="server-settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80"><div class="bg-[#36393f] rounded w-[600px] h-[500px] flex"><div class="w-1/3 bg-[#2f3136] p-4"><div class="text-white font-bold mb-4">SETTINGS</div><div class="flex flex-col gap-2 mb-4"><button onclick="window.showServerSettingsTab('roles')" class="text-gray-300 text-xs bg-gray-700 px-2 py-1 rounded text-left">Roles</button><button onclick="window.showServerSettingsTab('integrations')" class="text-gray-300 text-xs bg-gray-700 px-2 py-1 rounded text-left">Integrations</button><button onclick="window.showServerSettingsTab('bans')" class="text-gray-300 text-xs bg-gray-700 px-2 py-1 rounded text-left">Bans</button></div><button onclick="window.closeModal('server-settings-modal')" class="text-red-500">Exit</button></div><div class="flex-1 p-6 overflow-y-auto">
        <div id="settings-tab-roles">
            <h2 class="text-white font-bold mb-4">Roles</h2><div class="bg-[#2f3136] p-4 rounded mb-4"><input id="role-name-input" class="bg-[#202225] p-2 text-white w-full mb-2" placeholder="Name"><input type="color" id="role-color-input" class="mb-2"><div class="text-white space-y-1"><label class="block"><input type="checkbox" id="perm-manage"> Manage Channels</label><label class="block"><input type="checkbox" id="perm-kick"> Kick Members</label><label class="block"><input type="checkbox" id="perm-delete"> Delete Messages</label><label class="block"><input type="checkbox" id="perm-admin"> Admin</label></div><button onclick="window.createRole()" class="bg-green-600 w-full py-1 rounded text-white mt-2">Create Role</button></div><div id="roles-list" class="space-y-2"></div>
        </div>
        <div id="settings-tab-integrations" class="hidden">
             <h2 class="text-white font-bold mb-4">Integrations</h2>
             <div class="bg-[#2f3136] p-4 rounded flex items-center justify-between">
                 <div class="flex items-center"><div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center mr-3"><i class="fas fa-robot text-white"></i></div><div class="text-white"><div class="font-bold">Mody</div><div class="text-xs text-gray-400">Auto-moderation bot</div></div></div>
                 <button id="toggle-mody-btn" onclick="window.toggleMody()" class="bg-green-500 text-white px-3 py-1 rounded text-xs">Install</button>
             </div>
        </div>
        <div id="settings-tab-bans" class="hidden">
             <h2 class="text-white font-bold mb-4">Bans</h2>
             <div id="banned-users-list" class="space-y-2"></div>
        </div>
    </div></div></div>
    
    <div id="channel-settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80"><div class="bg-[#36393f] rounded w-[500px] h-[400px] flex flex-col p-4"><div class="flex justify-between mb-4"><h2 class="text-white font-bold">Permissions</h2><button onclick="window.closeModal('channel-settings-modal')" class="text-gray-400">x</button></div><div id="channel-roles-list" class="flex-1 overflow-y-auto"></div></div></div>
    <div id="member-action-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"><div class="bg-[#36393f] rounded p-4 w-64"><h3 id="action-username" class="text-white font-bold mb-2">User</h3><div id="action-roles-list" class="mb-2"></div><button onclick="window.reportUser()" class="w-full bg-yellow-600 text-white py-1 rounded mb-1">Report</button><button onclick="window.toggleBlockUser()" id="block-btn-text" class="w-full bg-gray-600 text-white py-1 rounded mb-1">Block</button><button id="kick-btn" onclick="window.kickUser()" class="w-full bg-orange-600 text-white py-1 rounded mb-1">Kick</button><button id="ban-btn" onclick="window.banUser()" class="w-full bg-red-600 text-white py-1 rounded mb-1">Ban</button><button onclick="window.removeFriend()" id="remove-friend-btn" class="w-full bg-red-800 text-white py-1 rounded mb-1 hidden">Unfriend</button><button onclick="window.closeModal('member-action-modal')" class="w-full text-gray-400 py-1">Cancel</button></div></div>
    <div id="user-settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80"><div class="bg-[#36393f] rounded w-[600px] flex"><div class="w-1/3 bg-[#2f3136] p-4"><div class="text-white font-bold mb-4">USER SETTINGS</div><div onclick="window.logout()" class="text-red-500 cursor-pointer mb-4">Log Out</div><div onclick="window.showNitroModal()" class="text-[#ff73fa] font-bold cursor-pointer">Nitro</div></div><div class="flex-1 p-6"><input id="edit-username-input" class="bg-[#202225] p-2 text-white w-full mb-2" placeholder="Username"><input id="edit-avatar-input" class="bg-[#202225] p-2 text-white w-full mb-2" placeholder="Avatar URL"><select id="edit-status-input" class="bg-[#202225] p-2 text-white w-full mb-2"><option value="online">Online</option><option value="idle">Idle</option><option value="offline">Invisible</option></select><div class="mb-2"><label class="text-xs text-gray-400">Profile Banner (Nitro Only)</label><input type="color" id="edit-banner-color" class="w-full h-8 bg-transparent"></div><input type="file" id="edit-avatar-file" class="text-gray-400 text-xs mb-4"><button onclick="window.saveProfile()" class="bg-green-600 w-full py-1 rounded text-white">Save</button><button onclick="window.closeModal('user-settings-modal')" class="text-gray-400 w-full mt-2">Close</button></div></div></div>
    <div id="admin-panel-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80"><div class="bg-[#36393f] rounded w-[800px] h-[600px] flex flex-col p-6 relative shadow-2xl"><div class="flex justify-between items-center mb-6 border-b border-[#202225] pb-4"><h2 class="text-white font-extrabold text-2xl flex items-center"><i class="fas fa-shield-alt text-red-500 mr-3"></i> ADMIN</h2><div class="flex gap-4"><button onclick="window.loadAdminView('users')" class="admin-tab active text-gray-400 font-bold hover:text-white pb-2">USERS</button><button onclick="window.loadAdminView('reports')" class="admin-tab text-gray-400 font-bold hover:text-white pb-2">REPORTS</button></div><button onclick="window.closeModal('admin-panel-modal')" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button></div><div class="flex gap-4 mb-4"><input id="admin-search" onkeyup="window.filterAdminUsers()" class="bg-[#202225] p-3 text-white flex-1 rounded font-medium" placeholder="Search"><div class="flex gap-2"><button onclick="window.openBroadcastModal()" class="bg-[#5865F2] text-white px-4 py-2 rounded font-bold shadow hover:bg-blue-600">Broadcast</button><button onclick="window.openPostUpdateModal()" class="bg-yellow-600 text-white px-4 py-2 rounded font-bold shadow hover:bg-yellow-700">Update</button></div></div><div id="admin-users-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar"></div></div></div>
    <div id="admin-user-action-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-90"><div class="bg-[#2f3136] rounded w-96 p-6 shadow-2xl border border-[#202225]"><h3 id="adm-act-title" class="text-white font-bold text-lg mb-4">Manage User</h3><div id="adm-btns"></div><div id="adm-history" class="mt-4 border-t border-[#202225] pt-2 text-xs text-gray-400 max-h-32 overflow-y-auto"></div><div class="mt-4"><input id="mod-reason" class="w-full bg-[#202225] p-2 text-white text-xs rounded mb-2" placeholder="Reason (Required)"><select id="mod-duration" class="w-full bg-[#202225] p-2 text-white text-xs rounded mb-2"><option value="">Duration (Temp Ban Only)</option><option value="3600000">1 Hour</option><option value="86400000">1 Day</option><option value="604800000">1 Week</option></select></div><button onclick="window.closeModal('admin-user-action-modal')" class="w-full text-gray-400 py-2 mt-2">Cancel</button></div></div>
    <div id="broadcast-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-90"><div class="bg-[#36393f] rounded w-[500px] p-6 shadow-2xl"><h2 class="text-white font-extrabold text-xl mb-4">Broadcast</h2><textarea id="broadcast-input" class="w-full bg-[#202225] p-3 text-white rounded mb-4 h-32 resize-none" placeholder="Message..."></textarea><div class="flex justify-end gap-2"><button onclick="window.closeModal('broadcast-modal')" class="text-gray-400">Cancel</button><button onclick="window.sendBroadcast()" class="bg-[#5865F2] text-white px-6 py-2 rounded font-bold">Send</button></div></div></div>
    <div id="post-update-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-90"><div class="bg-[#36393f] rounded w-[600px] p-6 shadow-2xl"><h2 class="text-white font-extrabold text-xl mb-4 text-yellow-500">Post New Update</h2><input id="upd-title" class="w-full bg-[#202225] p-3 text-white rounded mb-2 font-bold" placeholder="Update Title (Emojis supported üöÄ)"><div class="flex gap-2 mb-2"><button onclick="window.insertTag('<b>','</b>')" class="bg-[#202225] text-white px-3 py-1 rounded hover:bg-[#40444b]"><b>B</b></button><button onclick="window.insertTag('<u>','</u>')" class="bg-[#202225] text-white px-3 py-1 rounded hover:bg-[#40444b]"><u>U</u></button><button onclick="window.insertTag('<span style=\'font-size:1.2em\'>','</span>')" class="bg-[#202225] text-white px-3 py-1 rounded hover:bg-[#40444b]">Size+</button></div><textarea id="upd-desc" class="w-full bg-[#202225] p-3 text-white rounded mb-4 h-40 resize-none font-mono text-sm" placeholder="Description (HTML allowed)..."></textarea><div class="flex justify-end gap-2"><button onclick="window.closeModal('post-update-modal')" class="text-gray-400">Cancel</button><button onclick="window.postUpdate()" class="bg-yellow-600 text-white px-6 py-2 rounded font-bold hover:bg-yellow-700">Post Update</button></div></div></div>
    <div id="report-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70"><div class="bg-[#36393f] rounded w-80 p-4"><textarea id="report-reason" class="w-full bg-[#202225] p-2 text-white rounded h-24 mb-2" placeholder="Reason"></textarea><button onclick="window.submitReport()" class="bg-red-500 w-full py-1 rounded text-white">Submit</button><button onclick="window.closeModal('report-modal')" class="text-gray-400 w-full mt-1">Cancel</button></div></div>
    <div id="reaction-picker" class="hidden absolute bg-[#2f3136] shadow-xl rounded p-2 z-50 grid grid-cols-5 gap-1"></div>
    <div id="nitro-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black bg-opacity-90">
        <div class="bg-[#36393f] rounded w-[600px] p-6 text-center max-h-[90vh] overflow-y-auto">
            <h2 class="text-3xl font-extrabold nitro-gradient mb-4">W3Chat Nitro</h2>
            <p class="text-gray-300 mb-6">Enhance your experience with exclusive perks!</p>
            <table class="w-full text-left nitro-table mb-6">
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Basic</th>
                        <th>Nitro</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Server Limit</td><td>10</td><td><span class="text-[#ff73fa] font-bold">100</span></td></tr>
                    <tr><td>Character Limit</td><td>1,000</td><td><span class="text-[#ff73fa] font-bold">10,000</span></td></tr>
                    <tr><td>Profile Banner</td><td>Solid Color</td><td><span class="nitro-gradient">Gradient</span></td></tr>
                    <tr><td>Nitro Badge</td><td><i class="fas fa-times cross-icon"></i></td><td><i class="fas fa-check check-icon"></i></td></tr>
                    <tr><td>File Upload Limit</td><td>5 MB</td><td><span class="text-[#ff73fa] font-bold">50 MB</span></td></tr>
                </tbody>
            </table>
            <div class="flex gap-4 justify-center mb-6">
                <div class="nitro-card p-4 rounded flex-1">
                    <div class="text-lg font-bold text-white">Monthly</div>
                    <div class="text-2xl font-bold nitro-gradient">$9.99<span class="text-sm text-gray-400">/mo</span></div>
                    <button onclick="window.showToast('Nitro is coming soon!', 'info')" class="bg-[#5865F2] text-white w-full py-2 rounded mt-2 hover:bg-[#4752c4] transition">Subscribe</button>
                </div>
                <div class="nitro-card p-4 rounded flex-1 relative overflow-hidden">
                    <div class="absolute top-0 right-0 bg-[#ff73fa] text-black text-xs font-bold px-2 py-0.5">BEST VALUE</div>
                    <div class="text-lg font-bold text-white">Yearly</div>
                    <div class="text-2xl font-bold nitro-gradient">$99.99<span class="text-sm text-gray-400">/yr</span></div>
                    <div class="text-xs text-gray-400 mt-1">2 Months Free!</div>
                    <button onclick="window.showToast('Nitro is coming soon!', 'info')" class="bg-gradient-to-r from-[#ff00cc] to-[#3333ff] text-white w-full py-2 rounded mt-2 hover:opacity-90 transition">Subscribe</button>
                </div>
            </div>
            <button onclick="window.closeModal('nitro-modal')" class="text-gray-400 hover:text-white">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp, updateDoc, arrayUnion, arrayRemove, doc, getDoc, setDoc, getDocs, deleteDoc, deleteField, increment, limit, startAfter } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const cfg={apiKey:"AIzaSyB_wEHBTj2vYiXeoESIGgGCatnWgqW5P1w",authDomain:"w3chat-82711.firebaseapp.com",projectId:"w3chat-82711",storageBucket:"w3chat-82711.firebasestorage.app",messagingSenderId:"36226332250",appId:"1:36226332250:web:0514fee75633359ea50a63"};
        let app,auth,db;
        try{app=initializeApp(cfg);auth=getAuth(app);db=getFirestore(app);}catch(e){}

        let cur=null,sId=null,activeServerData=null,cId=null,cData=null,isDM=false,uCache={},call=null,pc=null,ls=null,repId=null,target=null,subs={},audioCtx=null,rec=null,recChunks=[],lastMsgTime=0;
        let lastMsgDoc=null, loadingMore=false;
        let deviceToken = localStorage.getItem('w3chat_dtoken');
        if(!deviceToken){ deviceToken = crypto.randomUUID(); localStorage.setItem('w3chat_dtoken', deviceToken); }

        const getEl=id=>document.getElementById(id);
        const toB64=f=>new Promise((r,j)=>{const rd=new FileReader();rd.readAsDataURL(f);rd.onload=()=>r(rd.result);rd.onerror=j;});
        const compressImg=(f)=>{return new Promise(r=>{const i=new Image();i.src=URL.createObjectURL(f);i.onload=()=>{const c=document.createElement('canvas'),ctx=c.getContext('2d'),m=800,s=m/i.width;c.width=s<1?i.width*s:i.width;c.height=s<1?i.height*s:i.height;ctx.drawImage(i,0,0,c.width,c.height);r(c.toDataURL('image/jpeg',0.7));};});};

        // --- GLOBAL FUNCTION DEFINITIONS (All exposed to window) ---
        window.getEl = getEl;
        window.openModal = id => getEl(id).classList.remove('hidden');
        window.closeModal = id => getEl(id).classList.add('hidden');
        window.toggleMemberList = () => getEl('member-list').classList.toggle('hidden');
        window.showMobileSidebar = () => {getEl('server-rail').classList.remove('hidden');getEl('sidebar-panel').classList.remove('-translate-x-full');getEl('main-panel').classList.add('translate-x-full');};
        window.addEmoji = e => { getEl('message-input').value += e; };
        
        window.enableAudio = () => {if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();audioCtx.resume();};
        window.playNotification = () => {let f=500,t='sine',d=0.2;if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type=t;o.frequency.setValueAtTime(f,audioCtx.currentTime);o.connect(g);g.connect(audioCtx.destination);o.start();g.gain.exponentialRampToValueAtTime(0.00001,audioCtx.currentTime+d);o.stop(audioCtx.currentTime+d);};
        window.playRingtone = () => {if(window.rInt)return;window.rInt=setInterval(()=>window.playNotification(),2000);};
        window.stopRingtone = () => {if(window.rInt){clearInterval(window.rInt);window.rInt=null;}};
        window.showNitroModal = () => {window.openModal('nitro-modal');};

        window.showLogin = () => {getEl('auth-screen').classList.remove('hidden');getEl('landing-page').classList.add('hidden');};
        window.hideLogin = () => {getEl('auth-screen').classList.add('hidden');getEl('landing-page').classList.remove('hidden');};
        window.copyInviteCode = () => {const e=getEl('invite-code-display');e.select();document.execCommand('copy');getEl('copy-btn').textContent="Copied!";};

        window.handleLogin = async (e) => {
            e.preventDefault();
            const em = getEl('email').value;
            const pw = getEl('password').value;
            try {
                await signInWithEmailAndPassword(auth, em, pw);
            } catch (err) {
                if(err.code.includes('not-found')||err.code.includes('invalid')){
                    try {
                        await createUserWithEmailAndPassword(auth, em, pw);
                        await setDoc(doc(db,"users",auth.currentUser.uid),{
                            username: em.split('@')[0],
                            email: em,
                            color: '#fff',
                            status: 'online',
                            friends: [],
                            requests: [],
                            deviceToken: deviceToken,
                            lastReadUpdateId: 0,
                            history: [],
                            isNitro: false,
                            bannerColor: '#000000'
                        });
                    } catch (e2) { getEl('login-msg').textContent=e2.message; }
                } else {
                    getEl('login-msg').textContent=err.message;
                }
            }
            return false;
        };

        window.handleForgotPassword = async () => {
            const em = getEl('email').value;
            if(!em) return window.showToast('Enter your email first', 'error');
            try {
                await sendPasswordResetEmail(auth, em);
                window.showToast('Password reset email sent!', 'success');
            } catch(e) {
                window.showToast(e.message, 'error');
            }
        };

        window.handleTyping = () => {
            // Placeholder for typing indicator logic
            console.log('Typing...');
        };

        window.handleCreateServer = async () => {
            if(!cur) return;
            const name = getEl('new-server-name').value;
            const icon = getEl('new-server-icon').value;
            const file = getEl('new-server-file').files[0];
            if(!name) return window.showToast('Server name required', 'error');
            
            let iconUrl = icon;
            if(file) {
                try { iconUrl = await compressImg(file); } catch(e) {}
            }
            
            const inviteCode = Math.random().toString(36).substring(2, 10);
            await addDoc(collection(db, "servers"), {
                name: name,
                icon: iconUrl || '',
                ownerId: cur.uid,
                members: [cur.uid],
                inviteCode: inviteCode,
                createdAt: serverTimestamp(),
                roles: {},
                userRoles: {},
                bannedUsers: []
            });
            window.closeModal('create-server-modal');
            window.showToast('Server created!', 'success');
        };

        window.handleJoinServer = async () => {
            const code = getEl('join-invite-code').value.trim();
            if(!code) return window.showToast('Enter invite code', 'error');
            
            const q = query(collection(db, "servers"), where("inviteCode", "==", code));
            const snap = await getDocs(q);
            if(snap.empty) return window.showToast('Invalid code', 'error');
            
            const serverDoc = snap.docs[0];
            const serverData = serverDoc.data();
            
            if(serverData.bannedUsers?.includes(cur.uid)) return window.showToast('You are banned from this server', 'error');
            if(serverData.members.includes(cur.uid)) return window.showToast('Already a member', 'error');
            
            await updateDoc(doc(db, "servers", serverDoc.id), {
                members: arrayUnion(cur.uid)
            });
            window.closeModal('join-server-modal');
            window.showToast('Joined server!', 'success');
        };

        window.joinInv = async (code) => {
            getEl('join-invite-code').value = code;
            await window.handleJoinServer();
        };

        window.handleCreateCategory = async () => {
            if(!activeServerData) return;
            const name = getEl('new-category-name').value;
            if(!name) return;
            await addDoc(collection(db, "channels"), {
                serverId: sId,
                type: 'category',
                name: name,
                position: 0
            });
            window.closeModal('create-category-modal');
        };

        window.handleCreateChannel = async () => {
            if(!activeServerData) return;
            const name = getEl('new-channel-name').value;
            const cat = getEl('new-channel-category').value;
            const ro = getEl('new-channel-readonly').checked;
            if(!name) return;
            await addDoc(collection(db, "channels"), {
                serverId: sId,
                type: 'text',
                name: name,
                category: cat,
                readOnly: ro,
                position: 0
            });
            window.closeModal('create-channel-modal');
            window.showToast('Channel created!', 'success');
        };

        window.handleCreateCategory = async () => {
            if(!activeServerData) return;
            const name = getEl('new-category-name').value;
            if(!name) return;
            await addDoc(collection(db, "channels"), {
                serverId: sId,
                type: 'category',
                name: name,
                position: 0
            });
            window.closeModal('create-category-modal');
        };

        window.sendFriendRequest = async () => {
            const username = getEl('friend-username-input').value;
            if(!username) return;
            const q = query(collection(db, "users"), where("username", "==", username));
            const snap = await getDocs(q);
            if(snap.empty) return window.showToast('User not found', 'error');
            const targetId = snap.docs[0].id;
            if(targetId === cur.uid) return window.showToast('Cannot add yourself', 'error');
            await updateDoc(doc(db, "users", targetId), {
                requests: arrayUnion(cur.uid)
            });
            window.closeModal('add-friend-modal');
            window.showToast('Friend request sent!', 'success');
        };

        window.accReq = async (uid) => {
            await updateDoc(doc(db, "users", cur.uid), {
                friends: arrayUnion(uid),
                requests: arrayRemove(uid)
            });
            await updateDoc(doc(db, "users", uid), {
                friends: arrayUnion(cur.uid)
            });
        };

        window.startDM = async (uid, uData) => {
            if(!cur) return;
            isDM = true;
            sId = null;
            activeServerData = null;
            cId = [cur.uid, uid].sort().join('_');
            cData = { type: 'dm', members: [cur.uid, uid] };
            
            getEl('friends-view').classList.add('hidden');
            getEl('messages-container').classList.remove('hidden');
            getEl('input-area').classList.remove('hidden');
            getEl('member-list').classList.add('hidden');
            getEl('dm-actions').classList.remove('hidden');
            getEl('chat-header').textContent = uData.username;
            getEl('channel-icon').className = 'fas fa-user text-[#72767d] mr-2 text-xl';
            
            loadMsgs(cId);
            
            if(window.innerWidth < 768) {
                getEl('sidebar-panel').classList.add('-translate-x-full');
                getEl('main-panel').classList.remove('translate-x-full');
            }
        };

        window.toggleUpdates = () => {
            const sb = getEl('updates-sidebar');
            if(sb.classList.contains('translate-x-full')) {
                sb.classList.remove('translate-x-full');
                if(cur) updateDoc(doc(db,"users",cur.uid), {lastReadUpdateId: Date.now()});
                getEl('update-badge').classList.add('hidden');
            } else {
                sb.classList.add('translate-x-full');
            }
        };

        window.startVoiceCall = () => {
            if(!cId) return;
            getEl('call-overlay').classList.remove('hidden');
            const room = `W3Chat_${cId}`;
            const domain = "meet.jit.si";
            const options = {
                roomName: room,
                width: "100%",
                height: "100%",
                parentNode: document.querySelector('#jitsi-container'),
                userInfo: { displayName: cur ? cur.username : 'User' },
                configOverwrite: { startWithVideoMuted: true, prejoinPageEnabled: false },
                interfaceConfigOverwrite: { FILM_STRIP_MAX_HEIGHT: 120 }
            };
            
            if(isDM && cur) {
                setDoc(doc(db,"channels",cId), {
                    activeCall: { status: 'ringing', caller: cur.uid, ts: serverTimestamp(), parts: [cur.uid] }
                }, { merge: true });
            }
            
            const s = document.createElement('script');
            s.src = `https://${domain}/external_api.js`;
            s.onload = () => { window.jitsiApi = new JitsiMeetExternalAPI(domain, options); };
            document.body.appendChild(s);
        };

        window.endVoiceCall = () => {
            getEl('call-overlay').classList.add('hidden');
            if(window.jitsiApi) {
                window.jitsiApi.dispose();
                window.jitsiApi = null;
            }
            if(isDM && cId) {
                updateDoc(doc(db, "channels", cId), { activeCall: deleteField() });
            }
        };

        window.answerVoiceCall = () => {
            getEl('incoming-call-banner').classList.add('hidden');
            window.stopRingtone();
            window.startVoiceCall();
        };

        window.declineVoiceCall = () => {
            getEl('incoming-call-banner').classList.add('hidden');
            window.stopRingtone();
            if(cId) {
                updateDoc(doc(db, "channels", cId), { activeCall: deleteField() });
            }
        };

        window.expandCall = () => {
            getEl('call-overlay').classList.remove('hidden');
        };

        window.toggleRecording = () => {
            const btn = getEl('record-btn');
            if(!rec) {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    rec = new MediaRecorder(stream);
                    recChunks = [];
                    rec.ondataavailable = e => recChunks.push(e.data);
                    rec.onstop = async () => {
                        const blob = new Blob(recChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.onloadend = async () => {
                            await addDoc(collection(db, "messages"), {
                                content: reader.result,
                                userId: cur.uid,
                                channelId: cId,
                                fileName: 'voice-message.webm',
                                createdAt: serverTimestamp()
                            });
                        };
                        reader.readAsDataURL(blob);
                    };
                    rec.start();
                    btn.classList.add('recording');
                });
            } else {
                rec.stop();
                rec = null;
                btn.classList.remove('recording');
            }
        };

        window.renderDiscovery = async () => {
            getEl('discovery-view').classList.remove('hidden');
            getEl('messages-container').classList.add('hidden');
            getEl('input-area').classList.add('hidden');
            getEl('friends-view').classList.add('hidden');
            
            const l = getEl('discovery-list');
            l.innerHTML = '<div class="text-white text-center">Loading...</div>';
            
            try {
                const snap = await getDocs(collection(db, "servers"));
                l.innerHTML = '';
                snap.forEach(d => {
                    const s = d.data();
                    if((s.members && s.members.length >= 5) || s.isPublic) {
                        l.innerHTML += `
                        <div class="bg-[#2f3136] p-4 rounded hover:bg-[#36393f] cursor-pointer transition" onclick="window.joinInv('${s.inviteCode}')">
                            <div class="flex items-center mb-2">
                                <div class="w-10 h-10 rounded-full bg-[#5865F2] flex items-center justify-center mr-3 text-white font-bold">
                                    ${s.name.substring(0,2)}
                                </div>
                                <div>
                                    <div class="font-bold text-white">${s.name}</div>
                                    <div class="text-gray-400 text-sm">${s.members ? s.members.length : 0} Members</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">Click to join</div>
                        </div>`;
                    }
                });
                if(l.innerHTML === '') l.innerHTML = '<div class="text-gray-500 text-center col-span-2">No public servers found.</div>';
            } catch(e) {
                l.innerHTML = '<div class="text-red-500 text-center">Error loading servers</div>';
            }
        };

        window.loadAdminView = async (tab) => {
            const l = getEl('admin-users-list');
            l.innerHTML = 'Loading...';
            
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            const tabs = document.querySelectorAll('.admin-tab');
            if(tab === 'users' && tabs[0]) tabs[0].classList.add('active');
            if(tab === 'reports' && tabs[1]) tabs[1].classList.add('active');
            
            if(tab === 'users') {
                try {
                    const s = await getDocs(collection(db, "users"));
                    l.innerHTML = '';
                    s.forEach(d => {
                        const u = d.data();
                        l.innerHTML += `
                        <div class="flex justify-between bg-[#2f3136] p-3 rounded items-center hover:bg-[#36393f]">
                            <div class="text-white">
                                <div class="font-bold">${u.username || 'Unknown'}</div>
                                <div class="text-xs text-gray-400">${u.email || 'No email'}</div>
                            </div>
                            <button onclick="window.openAdminAction('${d.id}','${(u.username || 'Unknown').replace(/'/g,"\\'")}',${u.isPlatformBanned || false})" class="bg-[#5865F2] text-white px-3 py-1 rounded text-xs hover:bg-blue-600">Manage</button>
                        </div>`;
                    });
                } catch(e) {
                    l.innerHTML = '<div class="text-red-500">Error loading users</div>';
                }
            } else if(tab === 'reports') {
                try {
                    const s = await getDocs(collection(db, "reports"));
                    l.innerHTML = '';
                    if(s.empty) {
                        l.innerHTML = '<div class="text-gray-500 text-center mt-4">No reports found.</div>';
                        return;
                    }
                    
                    for(const d of s.docs) {
                        const r = d.data();
                        const reporter = await getU(r.reporter);
                        const target = await getU(r.target);
                        l.innerHTML += `
                        <div class="bg-[#2f3136] p-3 rounded border-l-4 border-red-500 mb-2">
                            <div class="flex justify-between mb-1">
                                <span class="text-white font-bold">Reported: ${target.username}</span>
                                <span class="text-xs text-gray-400">By: ${reporter.username}</span>
                            </div>
                            <div class="text-sm text-[#dcddde] mb-2">${r.reason}</div>
                            <div class="flex gap-2">
                                <button onclick="window.openAdminAction('${r.target}','${target.username.replace(/'/g,"\\'")}',false)" class="bg-red-600 text-white px-2 py-1 rounded text-xs">Action</button>
                                <button onclick="window.deleteReport('${d.id}')" class="bg-gray-600 text-white px-2 py-1 rounded text-xs">Dismiss</button>
                            </div>
                        </div>`;
                    }
                } catch(e) {
                    l.innerHTML = '<div class="text-red-500">Error loading reports</div>';
                }
            }
        };

        window.openAdminAction = async (uid, username, isBanned) => {
            target = { uid, username };
            getEl('adm-act-title').textContent = `Manage ${username}`;
            const btns = getEl('adm-btns');
            btns.innerHTML = '';
            
            if(isBanned) {
                btns.innerHTML += `<button onclick="window.unbanUser('${uid}')" class="w-full bg-green-600 text-white py-2 rounded mb-2">Unban User</button>`;
            } else {
                btns.innerHTML += `<button onclick="window.banUser('${uid}')" class="w-full bg-red-600 text-white py-2 rounded mb-2">Ban User</button>`;
                btns.innerHTML += `<button onclick="window.tempBanUser('${uid}')" class="w-full bg-orange-600 text-white py-2 rounded mb-2">Temp Ban</button>`;
            }
            
            const userDoc = await getDoc(doc(db, "users", uid));
            if(userDoc.exists()) {
                const data = userDoc.data();
                const hist = data.history || [];
                getEl('adm-history').innerHTML = hist.map(h => `<div>${h}</div>`).join('') || 'No history';
            }
            
            window.openModal('admin-user-action-modal');
        };

        window.banUser = async (uid) => {
            const reason = getEl('mod-reason').value;
            if(!reason) return window.showToast('Reason required', 'error');
            await updateDoc(doc(db, "users", uid), { 
                isPlatformBanned: true,
                history: arrayUnion(`Banned: ${reason} (${new Date().toLocaleString()})`)
            });
            window.closeModal('admin-user-action-modal');
            window.showToast('User banned', 'success');
            window.loadAdminView('users');
        };

        window.tempBanUser = async (uid) => {
            const reason = getEl('mod-reason').value;
            const duration = getEl('mod-duration').value;
            if(!reason || !duration) return window.showToast('Reason and duration required', 'error');
            const expires = new Date(Date.now() + parseInt(duration));
            await updateDoc(doc(db, "users", uid), { 
                banExpires: expires,
                history: arrayUnion(`Temp banned until ${expires.toLocaleString()}: ${reason}`)
            });
            window.closeModal('admin-user-action-modal');
            window.showToast('User temp banned', 'success');
        };

        window.unbanUser = async (uid) => {
            await updateDoc(doc(db, "users", uid), { 
                isPlatformBanned: false,
                banExpires: null,
                history: arrayUnion(`Unbanned: ${new Date().toLocaleString()}`)
            });
            window.closeModal('admin-user-action-modal');
            window.showToast('User unbanned', 'success');
            window.loadAdminView('users');
        };

        window.deleteReport = async (rid) => {
            await deleteDoc(doc(db, "reports", rid));
            window.showToast('Report dismissed', 'success');
            window.loadAdminView('reports');
        };

        window.openBroadcastModal = () => {
            window.openModal('broadcast-modal');
        };

        window.sendBroadcast = async () => {
            const msg = getEl('broadcast-input').value;
            if(!msg) return;
            await setDoc(doc(db, "system", "broadcast"), {
                message: msg,
                ts: serverTimestamp()
            });
            window.closeModal('broadcast-modal');
            getEl('broadcast-input').value = '';
            window.showToast('Broadcast sent!', 'success');
        };

        window.openPostUpdateModal = () => {
            window.openModal('post-update-modal');
        };

        window.postUpdate = async () => {
            const title = getEl('upd-title').value;
            const desc = getEl('upd-desc').value;
            if(!title || !desc) return;
            await addDoc(collection(db, "system_updates"), {
                id: Date.now(),
                title: title,
                desc: desc,
                ts: serverTimestamp()
            });
            window.closeModal('post-update-modal');
            getEl('upd-title').value = '';
            getEl('upd-desc').value = '';
            window.showToast('Update posted!', 'success');
        };

        window.insertTag = (open, close) => {
            const ta = getEl('upd-desc');
            const start = ta.selectionStart;
            const end = ta.selectionEnd;
            const text = ta.value;
            ta.value = text.substring(0, start) + open + text.substring(start, end) + close + text.substring(end);
        };

        window.filterAdminUsers = () => {
            const q = getEl('admin-search').value.toLowerCase();
            const list = getEl('admin-users-list');
            Array.from(list.children).forEach(c => {
                c.style.display = c.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
            });
        };

        window.selChan = (id, data) => {
            cId = id;
            cData = data;
            isDM = false;
            
            getEl('messages-container').classList.remove('hidden');
            getEl('input-area').classList.remove('hidden');
            getEl('friends-view').classList.add('hidden');
            getEl('chat-header').textContent = data.name;
            getEl('channel-icon').className = 'fas fa-hashtag text-[#72767d] mr-2 text-xl';
            
            document.querySelectorAll('.ch-item').forEach(el => el.classList.remove('active', 'text-white'));
            const items = document.querySelectorAll('.ch-item');
            items.forEach(item => {
                if(item.textContent.includes(data.name)) {
                    item.classList.add('active', 'text-white');
                }
            });
            
            loadMsgs(id);
            
            if(window.innerWidth < 768) {
                getEl('sidebar-panel').classList.add('-translate-x-full');
                getEl('main-panel').classList.remove('translate-x-full');
            }
        };

        window.showDmAlert = (message) => {
            const modal = getEl('dm-alert-modal');
            const text = getEl('dm-alert-text');
            text.textContent = message;
            modal.classList.remove('hidden');
        };

        window.closeDmAlert = () => {
            getEl('dm-alert-modal').classList.add('hidden');
        };

        window.openServerSettings = () => {
            window.openModal('server-settings-modal');
            window.showServerSettingsTab('roles');
        };

        window.showServerSettingsTab = (tab) => {
            document.getElementById('settings-tab-roles').classList.add('hidden');
            document.getElementById('settings-tab-integrations').classList.add('hidden');
            document.getElementById('settings-tab-bans').classList.add('hidden');
            document.getElementById(`settings-tab-${tab}`).classList.remove('hidden');
            
            if(tab === 'bans' && activeServerData) {
                const list = getEl('banned-users-list');
                list.innerHTML = '';
                if(activeServerData.bannedUsers) {
                    activeServerData.bannedUsers.forEach(async uid => {
                        const u = await getU(uid);
                        list.innerHTML += `<div class="flex justify-between bg-[#202225] p-2 rounded"><span>${u.username}</span><button onclick="window.unbanServerUser('${uid}')" class="text-green-500 text-xs">Unban</button></div>`;
                    });
                }
            }
            if(tab === 'integrations') {
                const btn = getEl('toggle-mody-btn');
                if(activeServerData?.autoModEnabled) {
                    btn.textContent = 'Uninstall';
                    btn.className = 'bg-red-500 text-white px-3 py-1 rounded text-xs';
                } else {
                    btn.textContent = 'Install';
                    btn.className = 'bg-green-500 text-white px-3 py-1 rounded text-xs';
                }
            }
            if(tab === 'roles') {
                const list = getEl('roles-list');
                list.innerHTML = '';
                if(activeServerData?.roles) {
                    Object.entries(activeServerData.roles).forEach(([id, r]) => {
                        list.innerHTML += `<div class="bg-[#202225] p-2 rounded flex justify-between items-center"><span style="color:${r.color}">${r.name}</span><button onclick="window.deleteRole('${id}')" class="text-red-500 text-xs"><i class="fas fa-trash"></i></button></div>`;
                    });
                }
            }
        };

        window.createRole = async () => {
            const name = getEl('role-name-input').value;
            const color = getEl('role-color-input').value;
            const perms = {
                manage: getEl('perm-manage').checked,
                kick: getEl('perm-kick').checked,
                delete: getEl('perm-delete').checked,
                admin: getEl('perm-admin').checked
            };
            if(!name) return;
            const rid = 'role_' + Date.now();
            await updateDoc(doc(db, "servers", sId), {
                [`roles.${rid}`]: { name, color, ...perms, priority: Object.keys(activeServerData.roles || {}).length }
            });
            window.showToast('Role created!', 'success');
            getEl('role-name-input').value = '';
        };

        window.deleteRole = async (rid) => {
            await updateDoc(doc(db, "servers", sId), {
                [`roles.${rid}`]: deleteField()
            });
            window.showServerSettingsTab('roles');
        };

        window.toggleMody = async () => {
            const newState = !activeServerData.autoModEnabled;
            await updateDoc(doc(db, "servers", sId), { autoModEnabled: newState });
            activeServerData.autoModEnabled = newState;
            window.showServerSettingsTab('integrations');
            window.showToast(newState ? 'Mody installed!' : 'Mody uninstalled', 'success');
        };

        window.unbanServerUser = async (uid) => {
            await updateDoc(doc(db, "servers", sId), {
                bannedUsers: arrayRemove(uid)
            });
            window.showServerSettingsTab('bans');
        };

        window.openChannelSettings = () => {
            window.openModal('channel-settings-modal');
            const list = getEl('channel-roles-list');
            list.innerHTML = '';
            if(activeServerData?.roles) {
                Object.entries(activeServerData.roles).forEach(([id, r]) => {
                    list.innerHTML += `<div class="flex justify-between bg-[#202225] p-2 rounded mb-2"><span style="color:${r.color}">${r.name}</span><input type="checkbox" onchange="window.toggleChannelPerm('${id}', this.checked)"></div>`;
                });
            }
        };

        window.toggleChannelPerm = async (rid, allowed) => {
            // Placeholder for channel permission logic
        };

        window.loadInviteFriends = async () => {
            const list = getEl('invite-friends-list');
            list.innerHTML = '';
            if(!cur?.friends) return;
            for(const fid of cur.friends) {
                const f = await getU(fid);
                list.innerHTML += `<div class="flex justify-between bg-[#202225] p-2 rounded mb-1"><span>${f.username}</span><button onclick="window.inviteFriend('${fid}')" class="bg-[#5865F2] text-white px-2 py-1 rounded text-xs">Invite</button></div>`;
            }
        };

        window.inviteFriend = async (fid) => {
            if(!cId || !cur) return;
            await addDoc(collection(db, "messages"), {
                content: `INVITE: ${activeServerData.name} (${activeServerData.inviteCode})`,
                userId: cur.uid,
                channelId: [cur.uid, fid].sort().join('_'),
                createdAt: serverTimestamp()
            });
            window.showToast('Invite sent!', 'success');
        };

        window.openMemberMenu = (e, u) => {
            target = u;
            getEl('action-username').textContent = u.username;
            const isOwner = activeServerData?.ownerId === cur?.uid;
            const isAdmin = activeServerData?.userRoles?.[cur?.uid]?.some(r => activeServerData.roles?.[r]?.admin);
            getEl('kick-btn').classList.toggle('hidden', !isOwner && !isAdmin);
            getEl('ban-btn').classList.toggle('hidden', !isOwner && !isAdmin);
            getEl('remove-friend-btn').classList.toggle('hidden', !cur?.friends?.includes(u.uid));
            
            const rolesList = getEl('action-roles-list');
            rolesList.innerHTML = '';
            if(isOwner && activeServerData?.roles) {
                Object.entries(activeServerData.roles).forEach(([rid, r]) => {
                    const hasRole = activeServerData.userRoles?.[u.uid]?.includes(rid);
                    rolesList.innerHTML += `<button onclick="window.toggleUserRole('${u.uid}', '${rid}')" class="text-xs ${hasRole ? 'bg-green-600' : 'bg-gray-600'} text-white px-2 py-1 rounded mb-1 w-full">${r.name}</button>`;
                });
            }
            window.openModal('member-action-modal');
        };

        window.toggleUserRole = async (uid, rid) => {
            const hasRole = activeServerData.userRoles?.[uid]?.includes(rid);
            if(hasRole) {
                await updateDoc(doc(db, "servers", sId), {
                    [`userRoles.${uid}`]: arrayRemove(rid)
                });
            } else {
                await updateDoc(doc(db, "servers", sId), {
                    [`userRoles.${uid}`]: arrayUnion(rid)
                });
            }
            window.openMemberMenu(null, target);
        };

        window.reportUser = () => {
            window.closeModal('member-action-modal');
            window.openModal('report-modal');
        };

        window.submitReport = async () => {
            const reason = getEl('report-reason').value;
            if(!reason || !target) return;
            await addDoc(collection(db, "reports"), {
                reporter: cur.uid,
                target: target.uid,
                reason: reason,
                ts: serverTimestamp()
            });
            window.closeModal('report-modal');
            getEl('report-reason').value = '';
            window.showToast('Report submitted', 'success');
        };

        window.toggleBlockUser = async () => {
            if(!target) return;
            const isBlocked = cur.blocked?.includes(target.uid);
            if(isBlocked) {
                await updateDoc(doc(db, "users", cur.uid), {
                    blocked: arrayRemove(target.uid)
                });
            } else {
                await updateDoc(doc(db, "users", cur.uid), {
                    blocked: arrayUnion(target.uid)
                });
            }
            window.closeModal('member-action-modal');
            window.showToast(isBlocked ? 'User unblocked' : 'User blocked', 'success');
        };

        window.kickUser = async () => {
            if(!target || !activeServerData) return;
            await updateDoc(doc(db, "servers", sId), {
                members: arrayRemove(target.uid)
            });
            window.closeModal('member-action-modal');
            window.showToast('User kicked', 'success');
        };

        window.banUser = async () => {
            if(!target || !activeServerData) return;
            await updateDoc(doc(db, "servers", sId), {
                members: arrayRemove(target.uid),
                bannedUsers: arrayUnion(target.uid)
            });
            window.closeModal('member-action-modal');
            window.showToast('User banned from server', 'success');
        };

        window.removeFriend = async () => {
            if(!target) return;
            await updateDoc(doc(db, "users", cur.uid), {
                friends: arrayRemove(target.uid)
            });
            await updateDoc(doc(db, "users", target.uid), {
                friends: arrayRemove(cur.uid)
            });
            window.closeModal('member-action-modal');
            window.showToast('Friend removed', 'success');
        };

        window.saveProfile = async () => {
            if(!cur) return;
            const username = getEl('edit-username-input').value;
            const avatar = getEl('edit-avatar-input').value;
            const status = getEl('edit-status-input').value;
            const banner = getEl('edit-banner-color').value;
            const file = getEl('edit-avatar-file').files[0];
            
            let avatarUrl = avatar;
            if(file) {
                try { avatarUrl = await compressImg(file); } catch(e) {}
            }
            
            await updateDoc(doc(db, "users", cur.uid), {
                username: username || cur.username,
                avatar: avatarUrl || cur.avatar,
                status: status,
                bannerColor: banner
            });
            window.closeModal('user-settings-modal');
            window.showToast('Profile saved!', 'success');
        };

        window.initReply = (mid, content, username) => {
            repId = { id: mid, content, username };
            getEl('reply-bar').classList.remove('hidden');
            getEl('reply-username').textContent = username;
        };

        window.cancelReply = () => {
            repId = null;
            getEl('reply-bar').classList.add('hidden');
        };

        window.deleteMessage = async (mid) => {
            await deleteDoc(doc(db, "messages", mid));
        };

        async function getU(uid){
            if(uCache[uid]&&Date.now()-uCache[uid]._t<60000)return uCache[uid];
            const s=await getDoc(doc(db,"users",uid));
            const d=s.exists()?s.data():{username:'Unknown',color:'#777',status:'offline'};
            const u={uid:uid,...d,_t:Date.now()};
            uCache[uid]=u;
            return u;
        }
        
        function updateFoot(){
            if(!cur)return;
            getEl('current-username').textContent=cur.username;
            getEl('current-discriminator').textContent=`#${cur.uid.substring(0,4)}`;
            const img=getEl('current-user-img'),icon=getEl('current-user-icon');
            if(cur.avatar){img.src=cur.avatar;img.classList.remove('hidden');icon.classList.add('hidden');}
            else{img.classList.add('hidden');icon.classList.remove('hidden');getEl('current-user-avatar').style.backgroundColor=cur.color||'#5865F2';}
            getEl('connection-status').className=`status-dot status-${cur.status||'online'}`;
            getEl('edit-username-input').value=cur.username;
            getEl('edit-avatar-input').value=cur.avatar||'';
            getEl('edit-status-input').value=cur.status||'online';
            getEl('edit-banner-color').value=cur.bannerColor||'#000000';
            if(cur.isNitro) getEl('current-username').innerHTML = `<span class="nitro-gradient">${cur.username}</span> <i class="fas fa-rocket text-pink-500 text-xs"></i>`;
        }

        function renderMems(s){
            const l=getEl('member-list');l.innerHTML='';
            const memberList = [...(s.members||[])];
            if(activeServerData?.autoModEnabled) memberList.push('mody_bot');
            Promise.all(memberList.map(uid => uid === 'mody_bot' ? {uid:'mody', username:'Mody', color:'#5865F2', isBot:true, status:'online'} : getU(uid))).then(us=>{
                const g={Online:[],Offline:[]};
                if(activeServerData?.roles)Object.values(activeServerData.roles).sort((a,b)=>a.priority-b.priority).forEach(r=>g[r.name]=[]);
                us.forEach(u=>{
                    let gn='Online',c='#fff',p=999;
                    if(u.isBot){ gn='Online'; c='#5865F2'; }
                    else if(activeServerData?.userRoles?.[u.uid]){const rid=activeServerData.userRoles[u.uid][0],r=activeServerData.roles[rid];if(r){gn=r.name;c=r.color;p=r.priority;}}
                    if(s.ownerId===u.uid&&p===999){gn='Owner';c='#faa61a';}
                    if(u.status==='offline')gn='Offline';
                    if(!g[gn])g[gn]=[];g[gn].push({u,c});
                });
                Object.entries(g).forEach(([n,a])=>{
                    if(!a.length)return;
                    const h=document.createElement('div');h.className="text-[#96989d] text-xs font-bold uppercase mb-2 mt-4 px-2";h.textContent=`${n} ‚Äî ${a.length}`;l.appendChild(h);
                    a.forEach(x=>{
                        const d=document.createElement('div');d.className="flex items-center px-2 py-1.5 rounded hover:bg-[#35373c] cursor-pointer opacity-90 hover:opacity-100";
                        d.onclick=e=>window.openMemberMenu(e,x.u);
                        const badge = x.u.isBot ? '<span class="bot-tag"><i class="fas fa-check"></i> BOT</span>' : (x.u.isNitro ? '<i class="fas fa-rocket text-pink-500 ml-1 text-xs"></i>' : '');
                        d.innerHTML=`<div class="relative mr-3"><div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center overflow-hidden"><img src="${x.u.avatar||''}" class="w-full h-full object-cover" onerror="this.style.display='none'"></div><div class="status-dot status-${x.u.status==='idle'?'idle':x.u.status==='offline'?'offline':'online'}"></div></div><div class="text-sm font-medium" style="color:${n==='Offline'?'#747f8d':x.c}">${x.u.username} ${s.ownerId===x.u.uid?'<i class="fas fa-crown text-yellow-500 ml-1"></i>':''} ${badge}</div>`;
                        l.appendChild(d);
                    });
                });
            });
        }

        async function rMsg(m,c,prepend=false){
            const u=await getU(m.userId);
            let col='#fff';if(activeServerData?.userRoles?.[u.uid]){const rid=activeServerData.userRoles[u.uid][0];if(activeServerData.roles[rid])col=activeServerData.roles[rid].color;}
            let txt=m.content;
            if(txt.startsWith('data:image')) txt = `<img src="${m.content}" class="max-w-xs rounded mt-2 cursor-pointer" onclick="window.open(this.src)">`;
            else if(txt.startsWith('data:audio') || m.fileName?.endsWith('.webm')) txt = `<audio controls src="${m.content}" class="mt-2 w-64"></audio>`;
            else if(txt.startsWith('data:text') || txt.startsWith('data:application')) { txt = `<a href="${m.content}" download="${m.fileName||'file'}" class="flex items-center bg-[#2f3136] p-2 rounded max-w-xs text-[#00aff4] hover:underline mt-2"><i class="fas fa-file mr-2"></i> ${m.fileName||'Download File'}</a>`; }
            else { 
                if(txt.includes(`@${cur.username}`)) txt = txt.replace(`@${cur.username}`,`<span class="mention">@${cur.username}</span>`);
                if(txt.includes(`@everyone`)) txt = txt.replace(`@everyone`,`<span class="mention-everyone">@everyone</span>`); 
                if(txt.includes(`@here`)) txt = txt.replace(`@here`,`<span class="mention-everyone">@here</span>`);
                txt = txt.replace(/^#\s+(.*$)/gim, '<span class="text-2xl font-bold block">$1</span>');
                txt = txt.replace(/^##\s+(.*$)/gim, '<span class="text-xl font-bold block">$1</span>');
                if(activeServerData && activeServerData.roles) { Object.values(activeServerData.roles).forEach(r => { if(txt.includes(`@${r.name}`)) txt = txt.replace(`@${r.name}`, `<span class="role-mention" style="color:${r.color}">@${r.name}</span>`); }); }
                txt = txt.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" class="text-[#00aff4] hover:underline">$1</a>'); 
                if(txt.match(/\.(jpeg|jpg|gif|png)$/i)) txt=`<img src="${m.content}" class="max-w-xs rounded mt-2">`; 
            }
            const d=document.createElement('div');d.className="msg flex pr-4 pl-4 py-1 mt-1 hover:bg-[#32353b] group relative";let rep='';if(m.replyTo)rep=`<div class="text-xs text-[#b9bbbe] mb-1 flex items-center"><div class="w-8 border-t-2 border-l-2 border-[#4f545c] h-3 mr-1 rounded-tl-md"></div> <span class="font-bold text-white mr-1">${m.replyTo.username}</span>: ${m.replyTo.content.substring(0,30)}...</div>`;
            const own=activeServerData?.ownerId===cur?.uid;const roles=activeServerData?.roles||{};const del=own||(activeServerData?.userRoles?.[cur?.uid]||[]).some(r=>roles[r]?.deleteMessages)||m.userId===cur?.uid;
            let reacts = '';
            if(m.reactions) {
                reacts = `<div class="flex flex-wrap gap-1 mt-1 ml-14">`;
                Object.entries(m.reactions).forEach(([emoji, users]) => {
                    if(users.length > 0) {
                         const amI = users.includes(cur?.uid);
                         reacts += `<div class="reaction-pill ${amI?'active':''}" onclick="window.toggleReaction('${m.id}','${emoji}')"><span>${emoji}</span> <span class="font-bold text-xs">${users.length}</span></div>`;
                    }
                });
                reacts += `</div>`;
            }
            d.innerHTML=`<div class="w-10 h-10 rounded-full mr-4 bg-gray-600 overflow-hidden shrink-0 mt-1"><img src="${u.avatar||''}" class="w-full h-full object-cover" onerror="this.style.display='none'"></div><div class="flex-1 min-w-0">${rep}<div><span class="font-medium hover:underline cursor-pointer mr-2" style="color:${col}" onclick="window.openMemberMenu(event,{uid:'${u.uid}',username:'${u.username}'})">${u.username}</span><span class="text-xs text-[#72767d]">${m.createdAt?.toDate().toLocaleTimeString()||''}</span></div><div class="text-[#dcddde] whitespace-pre-wrap leading-6 markdown">${txt}</div>${reacts}</div><div class="acts absolute right-4 -top-2 bg-[#36393f] shadow-md border border-[#2f3136] rounded flex items-center p-1 hidden group-hover:flex"><i class="fas fa-smile text-[#b9bbbe] hover:text-white px-2 cursor-pointer" onmouseenter="window.showReactionPicker(this, '${m.id}')"></i><i class="fas fa-reply text-[#b9bbbe] hover:text-white px-2 cursor-pointer" onclick="window.initReply('${m.id}','${m.content.replace(/'/g,"\\'")}','${u.username}')"></i>${m.userId===cur?.uid?`<i class="fas fa-pencil-alt text-[#b9bbbe] hover:text-white px-2 cursor-pointer" onclick="window.startEditMessage('${m.id}','${m.content.replace(/'/g,"\\'")}', this)"></i>`:''}${del?`<i class="fas fa-trash text-[#ed4245] hover:text-red-400 px-2 cursor-pointer" onclick="window.deleteMessage('${m.id}')"></i>`:''}</div>`;
            if(m.content.includes("INVITE:")) d.querySelector('.markdown').innerHTML=`<div class="bg-[#2f3136] p-4 rounded mt-2 border-l-4 border-[#5865F2] w-64"><div class="font-bold text-[#b9bbbe] text-xs mb-2">YOU'VE BEEN INVITED</div><div class="font-bold text-white mb-2">${m.content.split('INVITE: ')[1].split(' (')[0]}</div><button onclick="window.joinInv('${m.content.split('(')[1].split(')')[0]}')" class="bg-[#3ba55c] text-white w-full py-2 rounded font-bold hover:bg-green-600">Join</button></div>`;
            if(prepend) c.prepend(d); else c.appendChild(d);
        }

        function loadMsgs(cid){
            if(subs.msg)subs.msg();
            lastMsgDoc=null; loadingMore=false;
            const c=getEl('messages-container');
            const q = query(collection(db,"messages"), where("channelId","==",cid));
            subs.msg=onSnapshot(q, s=>{
                if(s.empty) { c.innerHTML=''; return; }
                const msgs=[];
                s.forEach(d=>msgs.push({id:d.id,...d.data()}));
                msgs.sort((a,b)=>(a.createdAt?.toMillis()||0)-(b.createdAt?.toMillis()||0));
                const displayMsgs = msgs.slice(-50);
                c.innerHTML='';
                displayMsgs.forEach(x=>{if(!cur?.blocked?.includes(x.userId))rMsg(x,c,false);});
                setTimeout(()=>c.scrollTop=c.scrollHeight, 50);
            });
        }
        
        window.showReactionPicker = (el, mid) => {
            const p = getEl('reaction-picker');
            const rect = el.getBoundingClientRect();
            p.style.top = `${rect.top - 40}px`;
            p.style.left = `${rect.left - 80}px`;
            p.innerHTML = '';
            ['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò°','üéâ'].forEach(e => {
                const s = document.createElement('span'); s.textContent=e; s.className="cursor-pointer hover:bg-gray-700 p-1 rounded text-lg";
                s.onclick = () => { window.toggleReaction(mid, e); p.classList.add('hidden'); };
                p.appendChild(s);
            });
            p.classList.remove('hidden');
            setTimeout(()=>p.classList.add('hidden'), 3000);
        };
        
        window.toggleReaction = async (mid, emoji) => {
             const mRef = doc(db, "messages", mid);
             const mSnap = await getDoc(mRef);
             if(!mSnap.exists()) return;
             const r = mSnap.data().reactions || {};
             const users = r[emoji] || [];
             if(users.includes(cur?.uid)) { r[emoji] = users.filter(u => u !== cur?.uid); } 
             else { if(!r[emoji]) r[emoji] = []; r[emoji].push(cur?.uid); }
             await updateDoc(mRef, { reactions: r });
        };
        
        window.showToast = (msg, type='info') => {
             const c = getEl('toast-container');
             const d = document.createElement('div');
             d.className = `toast ${type}`;
             d.innerHTML = `<i class="fas ${type==='error'?'fa-exclamation-circle':type==='success'?'fa-check-circle':'fa-info-circle'} mr-2"></i> ${msg}`;
             c.appendChild(d);
             setTimeout(()=>d.classList.add('show'), 10);
             setTimeout(()=>{ d.classList.remove('show'); setTimeout(()=>d.remove(), 300); }, 3000);
        };
        
        window.startEditMessage = (mid, content, el) => {
             const container = el.closest('.msg').querySelector('.markdown');
             const originalHTML = container.innerHTML;
             container.innerHTML = `<input type="text" class="bg-[#202225] text-white p-1 rounded w-full border border-blue-500" value="${content}"><div class="text-[10px] mt-1"><span class="text-blue-400 cursor-pointer hover:underline" onclick="window.saveEdit('${mid}', this.parentElement.previousElementSibling.value)">Save</span> ‚Ä¢ <span class="text-gray-400 cursor-pointer hover:underline" onclick="this.closest('.markdown').innerHTML='${originalHTML.replace(/'/g,"\\'").replace(/"/g,'&quot;')}'">Cancel</span></div>`;
        };
        
        window.saveEdit = async (mid, newContent) => { await updateDoc(doc(db,"messages",mid), { content: newContent }); };
        
        function initCallG(){
            if(subs.call)subs.call();
            subs.call=onSnapshot(query(collection(db,"channels"),where("members","array-contains",cur?.uid)),s=>{
                let f=false;
                s.forEach(d=>{
                    const dt=d.data();
                    if(dt.activeCall&&dt.activeCall.status==='ringing'&&dt.activeCall.caller!==cur?.uid){
                        f=true;call=dt.activeCall;cId=d.id;
                        getEl('incoming-call-banner').classList.remove('hidden');
                        window.playRingtone();
                    }
                });
                if(!f){getEl('incoming-call-banner').classList.add('hidden');window.stopRingtone();}
            });
        }
        
        function initNotif(){
            if(subs.notif)subs.notif();
            subs.notif=onSnapshot(query(collection(db,`users/${cur?.uid}/notifications`)),s=>{
                let c=0;
                s.forEach(d=>{if(d.data().type==='dm')c++;});
                if(c>0){getEl('home-badge').classList.remove('hidden');getEl('home-badge').textContent=c;}
                else getEl('home-badge').classList.add('hidden');
                if(!s.empty&&s.docChanges().some(x=>x.type==='added'))window.playNotification();
            });
        }
        
        function initUpdates(){
            onSnapshot(collection(db,"system_updates"), s => {
                const l=getEl('updates-list');l.innerHTML='';
                let unseen = 0;
                const updates = [];
                s.forEach(d => updates.push(d.data()));
                updates.sort((a,b) => b.id - a.id);
                updates.forEach(u => {
                    if(!cur?.lastReadUpdateId || u.id > cur.lastReadUpdateId) unseen++;
                    l.innerHTML += `<div class="bg-[#36393f] p-3 rounded border-l-4 border-yellow-500 shadow mb-2"><div class="text-white font-bold text-lg mb-1">${u.title}</div><div class="text-[#dcddde] text-sm whitespace-pre-wrap">${u.desc}</div><div class="text-[#72767d] text-xs mt-2 text-right">${u.ts ? new Date(u.ts.toMillis()).toLocaleDateString() : 'Just now'}</div></div>`;
                });
                const b=getEl('update-badge');
                if(unseen > 0){ b.textContent=unseen; b.classList.remove('hidden'); } else { b.classList.add('hidden'); }
            });
        }
        
        function initApp(){
            if(!cur) return;
            subs.srv=onSnapshot(query(collection(db,"servers"),where("members","array-contains",cur.uid)),s=>{
                const l=getEl('server-list');l.innerHTML='';
                s.forEach(d=>{if(!d.data().bannedUsers?.includes(cur.uid))renderSI(d.id,d.data(),l);});
            });
            window.renderHome();
        }
        
        function renderSI(id,d,l){
            const b=document.createElement('div');b.className=`s-icon ${sId===id&&!isDM?'active':''}`;
            b.innerHTML = `<div class="unread-pill" id="unread-${id}"></div>`;
            if(d.icon){b.style.backgroundImage=`url('${d.icon}')`;b.style.backgroundSize='cover';}
            else b.innerHTML+=`<span class="font-bold text-sm">${d.name.substring(0,2)}</span>`;
            b.onclick=()=>window.selServ(id);l.appendChild(b);
        }
        
        window.selServ = (id) => {
            isDM=false;sId=id;getEl('dm-actions').classList.add('hidden');
            if(subs.as)subs.as();
            subs.as=onSnapshot(doc(db,"servers",id),s=>{
                if(s.exists()){
                    activeServerData={id:s.id,...s.data()};
                    renderMems(activeServerData);
                    const own=activeServerData.ownerId===cur?.uid;
                    const adm=own||(activeServerData.userRoles?.[cur?.uid]||[]).some(r=>activeServerData.roles?.[r]?.admin);
                    getEl('server-settings-icon').classList.toggle('hidden',!own);
                    getEl('invite-icon').classList.remove('hidden');
                    getEl('channel-settings-btn').classList.toggle('hidden',!adm);
                    getEl('sidebar-header').textContent=activeServerData.name;
                    getEl('invite-code-display').value=activeServerData.inviteCode;
                }
            });
            if(subs.ch)subs.ch();
            subs.ch=onSnapshot(query(collection(db,"channels"),where("serverId","==",id)),s=>{
                const l=getEl('channels-list');l.innerHTML='';
                const chs=[];s.forEach(d=>chs.push({id:d.id,...d.data()}));
                chs.sort((a,b)=>(a.position||0)-(b.position||0));
                const cats={},noc=[];
                chs.forEach(c=>{if(c.type==='category')cats[c.name]=[];else if(c.category&&cats[c.category])cats[c.category].push(c);else noc.push(c);});
                const own=activeServerData?.ownerId===cur?.uid;
                const adm=own||(activeServerData?.userRoles?.[cur?.uid]||[]).some(r=>activeServerData?.roles?.[r]?.manageChannels||activeServerData?.roles?.[r]?.admin);
                if(adm){
                    const b=document.createElement('div');b.className="text-[#00aff4] text-xs px-4 cursor-pointer mb-2 hover:underline";
                    b.textContent="+ Create Category";
                    b.onclick=()=>window.openModal('create-category-modal');
                    l.appendChild(b);
                }
                const rC=c=>{
                    const d=document.createElement('div');d.className=`ch-item px-2 py-1 mx-2 rounded cursor-pointer text-[#96989d] mb-0.5 flex justify-between group ${cId===c.id?'active text-white':''}`;
                    d.innerHTML=`<span><i class="fas fa-hashtag text-lg mr-1.5 opacity-60"></i> <span class="truncate">${c.name}</span></span>`;
                    d.onclick=()=>window.selChan(c.id,c);
                    return d;
                };
                noc.forEach(c=>l.appendChild(rC(c)));
                for(const[n,cs]of Object.entries(cats)){
                    const h=document.createElement('div');h.className="flex justify-between px-2 pt-4 pb-1 text-[#96989d] text-xs font-bold uppercase hover:text-white cursor-pointer";
                    h.innerHTML=`<span><i class="fas fa-chevron-down text-[10px] mr-1"></i> ${n}</span> <i class="fas fa-plus cursor-pointer hover:text-white ${adm?'':'hidden'}" onclick="event.stopPropagation();window.openModal('create-channel-modal');getEl('new-channel-category').value='${n}'"></i>`;
                    l.appendChild(h);cs.forEach(c=>l.appendChild(rC(c)));
                }
                const sel=getEl('new-channel-category');
                sel.innerHTML='<option value="">No Category</option>';
                Object.keys(cats).forEach(k=>sel.innerHTML+=`<option value="${k}">${k}</option>`);
                if(chs.length>0&&(!cId||isDM))window.selChan(chs[0].id,chs[0]);
            });
            if(window.innerWidth<768){
                getEl('server-rail').classList.remove('hidden');
                getEl('sidebar-panel').classList.remove('-translate-x-full');
                getEl('main-panel').classList.add('translate-x-full');
            }
        };
        
        window.renderHome=()=>{
            if(!cur) return;
            isDM=true;sId=null;activeServerData=null;
            getEl('server-settings-icon').classList.add('hidden');
            getEl('invite-icon').classList.add('hidden');
            getEl('channel-settings-btn').classList.add('hidden');
            getEl('dm-actions').classList.remove('hidden');
            getEl('sidebar-header').textContent="Direct Messages";
            getEl('messages-container').classList.add('hidden');
            getEl('input-area').classList.add('hidden');
            getEl('friends-view').classList.remove('hidden');
            getEl('member-list').classList.add('hidden');
            loadFriends();
            if(window.innerWidth<768){
                getEl('server-rail').classList.remove('hidden');
                getEl('sidebar-panel').classList.remove('-translate-x-full');
                getEl('main-panel').classList.add('translate-x-full');
            }
        };
        
        async function loadFriends(){
            if(!cur) return;
            getEl('channels-list').innerHTML=`<div class="px-4 py-4 text-[#72767d] text-xs font-bold uppercase">Direct Messages</div>`;
            const fl=getEl('friends-list');
            fl.innerHTML='';
            if(subs.f)subs.f();
            subs.f=onSnapshot(doc(db,"users",cur.uid),async s=>{
                if(!s.exists())return;
                const d=s.data();
                fl.innerHTML='';
                if(d.requests?.length){
                    fl.innerHTML+=`<div class="text-[#b9bbbe] text-xs font-bold mb-2">Pending</div>`;
                    for(const uid of d.requests){
                        const u=await getU(uid);
                        fl.innerHTML+=`<div class="flex justify-between p-2 bg-[#2f3136] rounded mb-1"><span class="text-white">${u.username}</span><button onclick="window.accReq('${uid}')" class="text-green-500 text-xs">Accept</button></div>`;
                    }
                }
                fl.innerHTML+=`<div class="text-[#b9bbbe] text-xs font-bold mt-4">Friends</div>`;
                for(const uid of(d.friends||[])){
                    const u=await getU(uid);
                    const d=document.createElement('div');
                    d.className="flex justify-between p-2 bg-[#2f3136] rounded mb-1 cursor-pointer hover:bg-[#36393f]";
                    d.innerHTML=`<div class="flex items-center"><div class="w-8 h-8 rounded-full mr-3 bg-gray-600 overflow-hidden"><img src="${u.avatar||''}" class="w-full h-full object-cover" onerror="this.style.display='none'"></div><span class="text-white">${u.username}</span></div>`;
                    d.onclick=()=>window.startDM(uid,u);
                    fl.appendChild(d);
                    const sb=document.createElement('div');
                    sb.className="channel-item px-2 py-2 mx-2 rounded cursor-pointer text-[#96989d] mb-1 flex items-center";
                    sb.innerHTML=`<i class="fas fa-user mr-2"></i> ${u.username}`;
                    sb.onclick=()=>window.startDM(uid,u);
                    getEl('channels-list').appendChild(sb);
                }
            });
        }

        // --- AUTH STATE ---
        if(auth){
            onAuthStateChanged(auth,async u=>{
                if(u){
                    const s=await getDoc(doc(db,"users",u.uid));
                    if(s.exists()){
                        const d=s.data();
                        if(d.isPlatformBanned){signOut(auth);return alert("You are permanently banned.");}
                        if(d.banExpires && d.banExpires.toMillis() > Date.now()){signOut(auth);return alert(`You are temporarily banned until ${new Date(d.banExpires.toMillis()).toLocaleString()}`);}
                        cur={uid:u.uid,...d};
                    } else {
                        cur={uid:u.uid,username:u.email.split('@')[0],color:'#fff'};
                        await setDoc(doc(db,"users",u.uid),cur);
                    }
                    getEl('auth-screen').classList.add('hidden');
                    getEl('landing-page').classList.add('hidden');
                    getEl('app-screen').classList.remove('hidden');
                    if(cur.email==="zacruze1@gmail.com")getEl('admin-panel-btn').classList.remove('hidden');
                    updateFoot();
                    initApp();
                    initNotif();
                    initCallG();
                    initUpdates();
                    
                    onSnapshot(doc(db, "system", "broadcast"), (doc) => {
                        if (doc.exists()) {
                            const data = doc.data();
                            if(Date.now() - data.ts.toMillis() < 60000) { 
                                window.showToast(`üì¢ ${data.message}`, 'broadcast'); 
                            }
                        }
                    });
                    
                    updateDoc(doc(db,"users",u.uid),{status:'online',lastActive:serverTimestamp()});
                } else {
                    cur=null;
                    getEl('app-screen').classList.add('hidden');
                    getEl('landing-page').classList.remove('hidden');
                }
            });
            window.logout=()=>{if(cur)updateDoc(doc(db,"users",cur.uid),{status:'offline'});signOut(auth);};
        }

        const msgInput = getEl('message-input');
        if(msgInput){
            msgInput.addEventListener('keypress',async e=>{
                if(e.key==='Enter'&&!e.shiftKey){
                    e.preventDefault();
                    const t=e.target.value.trim();
                    if(!t)return;
                    
                    if(Date.now() - lastMsgTime < 1000) return window.showToast("Slow down!", "error");
                    lastMsgTime = Date.now();
                    
                    const limit = cur?.isNitro ? 10000 : 1000;
                    if(t.length > limit) return window.showToast(`Message too long (Max ${limit})`, "error");

                    if(activeServerData) {
                       const isOwner = activeServerData.ownerId === cur?.uid;
                       const isAdmin = (activeServerData.userRoles?.[cur?.uid]||[]).some(r=>activeServerData.roles?.[r]?.admin);
                       if(cData?.readOnly && !isOwner && !isAdmin) return window.showToast("Channel is Read-Only", "error");
                    }

                    if(checkAutoMod(t)){ window.showToast("Mody: Language! Message blocked.", "error"); return; }
                    e.target.value='';
                    const m={content:t,userId:cur?.uid,channelId:cId,createdAt:serverTimestamp()};
                    if(repId){m.replyTo=repId;window.cancelReply();}
                    await addDoc(collection(db,"messages"),m);
                }
                window.handleTyping();
            });
        }
        
        const BAD_WORDS = ["badword1", "badword2", "fail", "idiot"]; 
        function checkAutoMod(text) {
             if (!activeServerData || !activeServerData.autoModEnabled) return false;
             if (activeServerData.ownerId === cur?.uid) return false;
             const lower = text.toLowerCase();
             for (const word of BAD_WORDS) { if (lower.includes(word)) return true; }
             return false;
        }

        // File input handler
        getEl('chat-file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file || !cId) return;
            
            let content;
            if(file.type.startsWith('image/')) {
                content = await compressImg(file);
            } else {
                content = await toB64(file);
            }
            
            await addDoc(collection(db, "messages"), {
                content: content,
                userId: cur?.uid,
                channelId: cId,
                fileName: file.name,
                createdAt: serverTimestamp()
            });
        });
    </script>
</body>
</html>